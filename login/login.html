<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Student Activity Portal</title>
  <link rel="stylesheet" href="/login/login.css">
</head>
<body>
  <div class="login-container">
    <h2>Welcome Back!</h2>
    <p>Login to your Student Activity Portal</p>

    <form id="loginForm">
      <input type="email" id="email" placeholder="Enter your Email" required>
      <input type="password" id="password" placeholder="Enter your Password" required>
      <button type="submit" class="btn-login">Login</button>
    </form>

    <div class="extra-links">
      <p>Don‚Äôt have an account? <a href="/login/register.html">Sign Up</a></p>
      <p><a href="/login/forgot password.html">Forgot Password?</a></p>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA9C1j6rc8QicmusZ3_tTlCMxfnqaXuYrg",
    authDomain: "hackathon-24389.firebaseapp.com",
    projectId: "hackathon-24389",
    storageBucket: "hackathon-24389.appspot.com",
    messagingSenderId: "223352153020",
    appId: "1:223352153020:web:4033ee61bbd488830e81b9",
    measurementId: "G-LVG5GVVE91"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ADMIN_EMAILS = ["admin@gmail.com", "superadmin@portal.com"];

  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      if (ADMIN_EMAILS.includes(email)) {
        window.location.href = "/admin/admin.html";
        return;
      }

      const userDocRef = doc(db, "users", user.uid);
      const userDoc = await getDoc(userDocRef);

      if (!userDoc.exists()) {
        alert("‚ö†Ô∏è User record not found.");
        await signOut(auth);
        return;
      }

      const userData = userDoc.data();
      const role = (userData.role || "").toLowerCase();
      const status = (userData.status || "").toLowerCase();

      // üîé Debugging Logs
      console.log("Fetched user data:", userData);
      console.log("Role from DB:", role);
      console.log("Status from DB:", status);

      if (role === "student") {
        if (status === "approved") {
          window.location.href = "/home/home2.html";
        } else {
          alert("‚ö†Ô∏è Your student account is pending faculty approval.");
          await signOut(auth);
        }
      } else if (role === "faculty") {
        if (status === "approved") {
          window.location.href = "/home/home.html";
        } else {
          alert("‚ö†Ô∏è Your faculty account is pending admin approval.");
          await signOut(auth);
        }
      } else {
        alert("‚ö†Ô∏è Unknown role. Contact admin.");
        await signOut(auth);
      }

    } catch (error) {
      let errorMessage = "An unknown error occurred. Please try again.";
      if (error.code === "auth/wrong-password" || error.code === "auth/user-not-found") {
        errorMessage = "Incorrect email or password.";
      } else if (error.code === "auth/too-many-requests") {
        errorMessage = "Too many failed attempts. Try later.";
      }
      alert("‚ùå " + errorMessage);
    }
  });
</script>


</body>
</html>
